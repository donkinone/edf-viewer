# EDF文件解析器

基于Java后端（Spring Boot + EDF4j）和Web前端的EDF文件解析应用。

## 项目结构

```
project/
├── backend/                    # Java后端
│   ├── src/
│   │   └── main/
│   │       ├── java/
│   │       │   └── com/edfapp/
│   │       │       ├── controller/     # REST API控制器
│   │       │       ├── service/        # 业务逻辑服务
│   │       │       └── util/           # EDF4j解析工具
│   │       └── resources/
│   │           └── application.properties
│   ├── pom.xml                # Maven配置
│   └── start.sh               # 启动脚本
├── public/                    # Web前端
│   ├── css/
│   │   └── styles.css         # 样式文件
│   ├── js/
│   │   └── script.js          # 前端逻辑
│   └── index.html             # 主页面
└── test.edf                   # 测试EDF文件
```

## 功能特性

- ✅ 支持批量上传EDF文件（最多3个）
- ✅ 文件大小限制（100MB）
- ✅ **智能数据采样**：大文件自动降采样（最多100,000点），避免JSON序列化堆栈溢出
- ✅ 拖拽上传功能
- ✅ 实时上传进度显示
- ✅ 详细的EDF文件信息展示
- ✅ 通道信息表格显示（包含采样信息）
- ✅ **EEG波形可视化与交互功能**
  - 🔄 **全通道同步**：所有通道的缩放和拖动完全同步，便于对比分析不同通道的信号特征
  - 🎯 **拖动平移**：在任意通道拖动，所有通道同步移动查看不同时间段（已优化速度）
  - 🔍 **滚轮缩放**：在任意通道缩放，所有通道同步放大/缩小时间窗口（智能中心点缩放）
  - 🔄 **双击重置**：双击任意通道，所有通道同步回到初始最小视图
  - 📊 **统一滚动条**：最后通道显示全局滚动条指示器，避免视觉干扰
  - ⚡ **统一缩放提示**：右上角显示全局缩放级别和时间跨度
  - 🎨 **优化渲染**：大数据量时自动采样，保证流畅性能
- ✅ 响应式设计

## 技术栈

### 后端
- **Java 11+**
- **Spring Boot 2.7.0** - Web框架
- **EDF4j** - EDF文件解析库
- **Maven** - 项目管理

### 前端
- **HTML5/CSS3/JavaScript**
- **原生JavaScript** - 无框架依赖
- **响应式设计**

## 安装要求

### Java后端
- Java 11 或更高版本
- Maven 3.6+

### 前端
- 现代浏览器（支持ES6+）

## 快速开始

### 1. 启动Java后端

```bash
# 进入后端目录
cd backend

# 使用启动脚本（推荐）
./start.sh

# 或者手动启动
mvn clean compile
mvn spring-boot:run
```

后端服务将在 `http://localhost:8080` 启动

### 2. 打开前端页面

直接在浏览器中打开 `public/index.html` 文件，或者使用本地服务器：

```bash
# 使用Python简单服务器
cd public
python3 -m http.server 3000

# 或使用Node.js serve
npx serve public -p 3000
```

前端页面将在 `http://localhost:3000` 可用

### 3. 使用应用

1. 打开前端页面
2. 选择或拖拽EDF文件到上传区域
3. 点击"上传文件"按钮
4. 查看解析结果

### 4. 测试修复功能

访问 `http://localhost:3000/test-drag-fixed.html` 查看修复详情和测试指南。

## 🎮 EEG波形交互操作指南

上传EDF文件后，你可以通过以下方式与EEG波形图进行交互：

### 基本操作

| 操作 | 方法 | 说明 |
|------|------|------|
| **拖动平移** | 在任意通道拖动鼠标左键 | 所有通道同步左右移动查看不同时间段 |
| **缩放** | 在任意通道滚动鼠标滚轮 | 所有通道同步缩放时间窗口（以鼠标位置为中心） |
| **重置视图** | 双击任意通道canvas | 所有通道同步回到初始的最小视图 |

### 视觉反馈

- **🔄 同步状态**：所有通道保持完全同步的时间窗口和缩放级别
- **光标变化**：悬停时显示抓手图标，拖动时所有通道显示抓取图标
- **边框高亮**：鼠标悬停时canvas边框变为蓝色并有阴影效果
- **统一滚动条**：最后一个通道底部显示全局蓝色滚动条，表示当前查看位置
- **统一缩放提示**：缩放时右上角显示全局缩放比例和时间跨度
- **操作提示**：交互指南说明同步操作方式

### 性能优化

- **智能采样**：当数据点密度过高时，自动进行视觉采样以保证流畅性
- **边界限制**：防止拖动超出数据范围
- **缩放限制**：最小缩放到1%（约36秒），最大100%（全部数据）

### 🔧 最新修复 (v1.4)

- **🗑️ 移除时间轴**：移除底部时间轴显示，界面更简洁，减少视觉干扰
- **🔄 全通道同步**：所有EEG通道的缩放和拖动完全同步，便于对比分析
- **统一状态管理**：创建全局同步状态，所有通道共享时间窗口
- **批量重绘优化**：状态变化时高效地同时重绘所有通道
- **UI简化优化**：减少重复的滚动条和缩放提示，界面更简洁
- **专业体验提升**：符合医疗设备和专业EEG分析软件的操作习惯

### 技术特性

- **数据窗口管理**：类似K线图的窗口滑动机制
- **事件防抖**：优化拖动和缩放的响应性能
- **内存优化**：只渲染当前窗口的数据，减少内存占用

## API接口

### 上传EDF文件
- **URL**: `POST /api/upload`
- **参数**: `files` (multipart/form-data)
- **限制**: 最多3个文件，每个文件最大100MB
- **返回**: JSON格式的解析结果

### 健康检查
- **URL**: `GET /api/health`
- **返回**: 服务状态信息

## 配置说明

### 后端配置 (application.properties)
```properties
server.port=8080
spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=300MB
```

### 前端配置
前端通过 `script.js` 中的API地址连接后端：
```javascript
xhr.open('POST', 'http://localhost:8080/api/upload');
```

## 故障排除

### 常见问题

1. **Java后端启动失败**
   - 检查Java版本：`java -version`
   - 检查Maven版本：`mvn -version`
   - 查看端口8080是否被占用

2. **前端无法连接后端**
   - 确认后端服务已启动
   - 检查浏览器控制台的CORS错误
   - 确认API地址正确

3. **文件上传失败**
   - 检查文件格式是否为.edf
   - 确认文件大小不超过100MB
   - 查看浏览器网络面板的错误信息

4. **"maximum call stack size exceeded" 错误**
   - 这个问题已在v1.2版本中修复
   - 后端现在自动对大文件进行智能采样
   - 如果仍遇到此错误，请确保使用最新版本的代码

## 开发说明

### 添加新功能
1. 后端：在相应的Controller/Service中添加逻辑
2. 前端：修改 `script.js` 和 `styles.css`

### 调试
- 后端日志：查看控制台输出
- 前端调试：使用浏览器开发者工具

## 许可证

本项目使用 MIT 许可证。EDF4j库也使用MIT许可证。

## 参考资料

- [EDF4j GitHub](https://github.com/MIOB/EDF4j)
- [Spring Boot文档](https://spring.io/projects/spring-boot)
- [EDF格式规范](https://www.edfplus.info/) 